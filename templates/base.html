<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Story Types{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Two-panel layout -->
        <div class="two-panel-layout">
            <!-- Left panel for user selections and controls -->
            <div class="left-panel">
                <div class="save-load-controls">
                    <a href="{{ url_for('save_story') }}" class="btn btn-save">üì• Save</a>
                    <form id="load-form" method="POST" action="{{ url_for('load_story') }}" enctype="multipart/form-data" style="display: inline;">
                        <label for="load-file" class="btn btn-load">üì§ Load</label>
                        <input type="file" id="load-file" name="file" accept=".json" style="display: none;">
                    </form>
                    <button class="btn btn-new" onclick="confirmNewStory()">üÜï New</button>
                </div>
                
                {% block user_selections %}
                    <div class="user-selections">
                        <h3>Your Story Selections</h3>
                        <div class="selections-content">
                            {% if session.get('story_data') %}
                                {% set story_data = session.get('story_data') %}
                                {% if story_data.get('story_type_name') %}
                                <!-- Story Type with expandable details -->
                                {% if story_type %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleStoryTypeDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Story Type:</strong> {{ story_data.get('story_type_name') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='story_type') }}" class="edit-button" title="Edit Story Type">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="story-type-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="story-type-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ story_type.description }}</div>
                                        </div>

                                        {% if story_type.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ story_type.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.narrative_elements %}
                                        <div class="section">
                                            <div class="section-title">Narrative Elements</div>
                                            <div class="section-content">{{ story_type.narrative_elements }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.emotional_arc %}
                                        <div class="section">
                                            <div class="section-title">Emotional Arc</div>
                                            <div class="section-content">{{ story_type.emotional_arc | arrow_format }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.key_moment %}
                                        <div class="section">
                                            <div class="section-title">Key Moments</div>
                                            <div class="section-content">
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    {% for moment in story_type.key_moment %}
                                                    <li>{{ moment }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.common_elements %}
                                        <div class="section">
                                            <div class="section-title">Common Elements</div>
                                            <div class="section-content">{{ story_type.common_elements | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when story_type is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Story Type:</strong> {{ story_data.get('story_type_name') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='story_type') }}" class="edit-button" title="Edit Story Type">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Story Sub-Type with expandable details (separate from story type) -->
                                {% if story_data.get('subtype_name') %}
                                {% if subtype %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleSubtypeDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Story Sub-Type:</strong> {{ story_data.get('subtype_name') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='subtype') }}" class="edit-button" title="Edit Story Sub-Type">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="subtype-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="subtype-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ subtype.description }}</div>
                                        </div>

                                        {% if subtype.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ subtype.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when subtype object is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Story Sub-Type:</strong> {{ story_data.get('subtype_name') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='subtype') }}" class="edit-button" title="Edit Story Sub-Type">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                {% endif %}
                                {% if story_data.get('key_theme') %}
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Key Theme:</strong> {{ story_data.get('key_theme') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='key_theme') }}" class="edit-button" title="Edit Key Theme">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% if story_data.get('core_arc') %}
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Core Arc:</strong> {{ story_data.get('core_arc') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='core_arc') }}" class="edit-button" title="Edit Core Arc">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Genre with expandable details -->
                                {% if story_data.get('genre_name') %}
                                {% if story and story.genre %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleGenreDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Genre:</strong> {{ story_data.get('genre_name') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='genre') }}" class="edit-button" title="Edit Genre">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="genre-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="genre-details-content">
                                        {% if story.genre.subgenres %}
                                        <div class="section">
                                            <div class="section-title">Sub-Genres</div>
                                            <div class="section-content">
                                                {% for subgenre in story.genre.subgenres %}
                                                    {{ subgenre.name }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when genre object is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Genre:</strong> {{ story_data.get('genre_name') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='genre') }}" class="edit-button" title="Edit Genre">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                
                                <!-- Sub-Genre with expandable details -->
                                {% if story_data.get('sub_genre_name') %}
                                {% if story and story.sub_genre %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleSubGenreDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Sub-Genre:</strong> {{ story_data.get('sub_genre_name') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='sub_genre') }}" class="edit-button" title="Edit Sub-Genre">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="subgenre-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="subgenre-details-content">
                                        {% if story.sub_genre.plot %}
                                        <div class="section">
                                            <div class="section-title">Plot Type</div>
                                            <div class="section-content">{{ story.sub_genre.plot }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if story.sub_genre.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ story.sub_genre.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if story.sub_genre.archetypes %}
                                        <div class="section">
                                            <div class="section-title">Typical Archetypes</div>
                                            <div class="section-content">{{ story.sub_genre.archetypes | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when sub-genre object is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Sub-Genre:</strong> {{ story_data.get('sub_genre_name') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='sub_genre') }}" class="edit-button" title="Edit Sub-Genre">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
          
                                <!-- Writing Style with expandable details -->
                                {% if story_data.get('writing_style_name') %}
                                {% if writing_style_obj %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleWritingStyleDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Writing Style:</strong> {{ story_data.get('writing_style_name') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='writing_style') }}" class="edit-button" title="Edit Writing Style">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="writingstyle-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="writingstyle-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ writing_style_obj.description }}</div>
                                        </div>
                                        
                                        {% if writing_style_obj.characteristics %}
                                        <div class="section">
                                            <div class="section-title">Characteristics</div>
                                            <div class="section-content">
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    {% for characteristic in writing_style_obj.characteristics %}
                                                    <li>{{ characteristic }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if writing_style_obj.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ writing_style_obj.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when writing style object is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Writing Style:</strong> {{ story_data.get('writing_style_name') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='writing_style') }}" class="edit-button" title="Edit Writing Style">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}

                                <!-- Protagonist with expandable details -->

                                {% if story_data.get('protagonist_archetype') %}
                                {% if protagonist_archetype_obj %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleProtagonistDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Protagonist:</strong> {{ story_data.get('protagonist_archetype') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='protagonist_archetype') }}" class="edit-button" title="Edit Protagonist">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="protagonist-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="protagonist-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ protagonist_archetype_obj.description }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when protagonist archetype object is not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Protagonist:</strong> {{ story_data.get('protagonist_archetype') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='protagonist_archetype') }}" class="edit-button" title="Edit Protagonist">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                
                                <!-- Live Secondary Characters selection (on secondary selection page) -->
                                {% if is_secondary_selection_page and story_data and story_data.get('protagonist_archetype') %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleLiveSecondaryDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Secondary Characters:</strong> <span id="live-secondary-list">none</span>
                                        </div>
                                        <div class="panel-controls">
                                            <span class="expand-arrow" id="live-secondary-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="live-secondary-details-content">
                                        <div id="live-secondary-descriptions"></div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Secondary Characters with expandable details -->
                                {% if story_data.get('secondary_archetypes') %}
                                {% if secondary_archetype_objs %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="toggleSecondaryDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Secondary Characters:</strong> {{ story_data.get('secondary_archetypes') | join(', ') }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('navigate_to_step', step='secondary_archetypes') }}" class="edit-button" title="Edit Secondary Characters">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="secondary-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="secondary-details-content">
                                        {% for archetype in secondary_archetype_objs %}
                                        <div class="section">
                                            <div class="section-title">{{ archetype.name }}</div>
                                            <div class="section-content">{{ archetype.description }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when secondary archetype objects are not available -->
                                <div class="selection-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Secondary Characters:</strong> {{ story_data.get('secondary_archetypes') | join(', ') }}
                                        </div>
                                        <a href="{{ url_for('navigate_to_step', step='secondary_archetypes') }}" class="edit-button" title="Edit Secondary Characters">‚úèÔ∏è</a>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}

                                
                                <!-- Selected Plot Line with expandable details -->
                                {% if story and story.selected_plot_line %}
                                <div class="expandable-panel">
                                    <div class="expandable-panel-header" onclick="togglePlotLineDetails()">
                                        <div class="expandable-panel-label">
                                            <strong>Selected Plot Line:</strong> {{ story.selected_plot_line.name }}
                                        </div>
                                        <div class="panel-controls">
                                            <a href="{{ url_for('complete_story_selection') }}" class="edit-button" title="Change Plot Line">‚úèÔ∏è</a>
                                            <span class="expand-arrow" id="plotline-expand-arrow">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="expandable-panel-content" id="plotline-details-content">
                                        <div class="section">
                                            <div class="section-title">Plot Line</div>
                                            <div class="section-content">{{ story.selected_plot_line.plotline }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Note and Generate plot lines button - appears when user has reached protagonist archetype selection -->
                                {% if story_data and story_data.get('protagonist_archetype') %}
                                <div class="secondary-notes-section" id="secondary-notes-section" {% if is_story_complete %}style="display: none;"{% endif %}>
                                    <div class="archetype-selection-info">
                                        <p><strong>Note:</strong> Selection of secondary character archetypes is optional. You can select multiple archetypes or none at all. These will be some of supporting characters in your story. If you don't select any, they will be chosen for you.</p>
                                    </div>
                                </div>
                                <div class="generate-plotlines-section" id="generate-plotlines-section" {% if is_story_complete %}style="display: none;"{% endif %}>
                                    <button class="generate-plotlines-button" id="generate-plotlines-button" onclick="handleGeneratePlotLines(event)">
                                        üìã Generate plot lines
                                    </button>
                                </div>
                                <div id="left-panel-loading" style="display: none;" class="loading-message">
                                    <p>Generating potential plot lines. This could take a few moments.</p>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="no-selections">
                                    No selections made yet. Start by choosing a story type.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endblock %}
            </div>
            
            <!-- Right panel for choices and navigation -->
            <div class="right-panel">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages">
                            {% for category, message in messages %}
                                <div class="flash-message flash-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('load-file').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                // Submit the form to let the server handle the redirect properly
                document.getElementById('load-form').submit();
            }
        });
        
        function confirmNewStory() {
            if (confirm('Are you sure you want to start a new story? This will clear all your current selections.')) {
                window.location.href = '{{ url_for("new_story") }}';
            }
        }
        
        function toggleStoryTypeDetails() {
            const content = document.getElementById('story-type-details-content');
            const arrow = document.getElementById('story-type-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        // Prevent edit button clicks from triggering panel toggle
        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('.edit-button');
            editButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        });
        
        function toggleSubtypeDetails() {
            const content = document.getElementById('subtype-details-content');
            const arrow = document.getElementById('subtype-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleGenreDetails() {
            const content = document.getElementById('genre-details-content');
            const arrow = document.getElementById('genre-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleSubGenreDetails() {
            const content = document.getElementById('subgenre-details-content');
            const arrow = document.getElementById('subgenre-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleProtagonistDetails() {
            const content = document.getElementById('protagonist-details-content');
            const arrow = document.getElementById('protagonist-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleWritingStyleDetails() {
            const content = document.getElementById('writingstyle-details-content');
            const arrow = document.getElementById('writingstyle-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleSecondaryDetails() {
            const content = document.getElementById('secondary-details-content');
            const arrow = document.getElementById('secondary-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        

        function toggleLiveSecondaryDetails() {
            const content = document.getElementById('live-secondary-details-content');
            const arrow = document.getElementById('live-secondary-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function togglePlotLineDetails() {
            const content = document.getElementById('plotline-details-content');
            const arrow = document.getElementById('plotline-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function handleGeneratePlotLines(event) {
            // Always prevent default action since this is now a button
            event.preventDefault();
            
            // Hide the button and note, show loading message
            const button = document.getElementById('generate-plotlines-button');
            const notesSection = document.getElementById('secondary-notes-section');
            const plotlinesSection = document.getElementById('generate-plotlines-section');
            const loadingIndicator = document.getElementById('left-panel-loading');
            
            if (button) button.style.display = 'none';
            if (notesSection) notesSection.style.display = 'none';
            if (plotlinesSection) plotlinesSection.style.display = 'none';
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            
            // Make API call to generate plot lines
            fetch('/generate-plot-lines', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.plot_lines) {
                    // Store plot lines in sessionStorage for the completion page
                    sessionStorage.setItem('generated_plot_lines', JSON.stringify(data.plot_lines));
                    sessionStorage.setItem('plot_lines_generated', 'true');
                    
                    // Navigate to story completion page
                    window.location.href = '/complete-story-selection';
                } else {
                    // Show error and restore UI
                    alert('Error generating plot lines: ' + (data.error || 'Unknown error'));
                    restoreGenerateButton();
                }
            })
            .catch(error => {
                // Show error and restore UI
                alert('Network error: ' + error.message);
                restoreGenerateButton();
            });
            
            return false;
        }
        
        function restoreGenerateButton() {
            const button = document.getElementById('generate-plotlines-button');
            const notesSection = document.getElementById('secondary-notes-section');
            const plotlinesSection = document.getElementById('generate-plotlines-section');
            const loadingIndicator = document.getElementById('left-panel-loading');
            
            if (button) button.style.display = 'inline-block';
            if (notesSection) notesSection.style.display = 'block';
            if (plotlinesSection) plotlinesSection.style.display = 'block';
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
        
        // Function to update live secondary characters display
        function updateLiveSecondaryCharacters() {
            const checkboxes = document.querySelectorAll('input[name="secondary_archetypes"]:checked');
            const liveList = document.getElementById('live-secondary-list');
            const liveDescriptions = document.getElementById('live-secondary-descriptions');
            
            if (!liveList || !liveDescriptions) return;
            
            if (checkboxes.length === 0) {
                liveList.textContent = 'none';
                liveDescriptions.innerHTML = '';
            } else {
                const selectedNames = [];
                const descriptions = [];
                
                checkboxes.forEach(checkbox => {
                    const archetypeCard = checkbox.closest('.archetype-card');
                    if (archetypeCard) {
                        const nameElement = archetypeCard.querySelector('.archetype-name');
                        const descElement = archetypeCard.querySelector('.archetype-description');
                        if (nameElement && descElement) {
                            selectedNames.push(nameElement.textContent.trim());
                            descriptions.push({
                                name: nameElement.textContent.trim(),
                                description: descElement.textContent.trim()
                            });
                        }
                    }
                });
                
                liveList.textContent = selectedNames.join(', ');
                
                // Build descriptions HTML
                let descriptionsHtml = '';
                descriptions.forEach(item => {
                    descriptionsHtml += `
                        <div class="section">
                            <div class="section-title">${item.name}</div>
                            <div class="section-content">${item.description}</div>
                        </div>
                    `;
                });
                liveDescriptions.innerHTML = descriptionsHtml;
            }
        }
        
        // Initialize live secondary characters monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Monitor secondary archetype checkboxes
            const checkboxes = document.querySelectorAll('input[name="secondary_archetypes"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateLiveSecondaryCharacters);
            });
            
            // Initial update
            updateLiveSecondaryCharacters();
        });
    </script>
</body>
</html>