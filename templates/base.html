<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Story Types{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Two-panel layout -->
        <div class="two-panel-layout">
            <!-- Left panel for user selections and controls -->
            <div class="left-panel">
                <div class="save-load-controls">
                    <a href="{{ url_for('save_story') }}" class="btn btn-save">üì• Save</a>
                    <form id="load-form" method="POST" action="{{ url_for('load_story') }}" enctype="multipart/form-data" style="display: inline;">
                        <label for="load-file" class="btn btn-load">üì§ Load</label>
                        <input type="file" id="load-file" name="file" accept=".json" style="display: none;">
                    </form>
                    <button class="btn btn-new" onclick="confirmNewStory()">üÜï New</button>
                </div>
                
                {% block user_selections %}
                    <div class="user-selections">
                        <h3>Your Story Selections</h3>
                        <div class="selections-content">
                            {% if session.get('story_data') %}
                                {% set story_data = session.get('story_data') %}
                                {% if story_data.get('story_type_name') %}
                                <!-- Story Type with expandable details -->
                                {% if story_type %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='story_type') }}" class="edit-button-external" title="Edit Story Type">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleStoryTypeDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Story Type:</strong> {{ story_data.get('story_type_name') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="story-type-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="story-type-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ story_type.description }}</div>
                                        </div>

                                        {% if story_type.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ story_type.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.narrative_elements %}
                                        <div class="section">
                                            <div class="section-title">Narrative Elements</div>
                                            <div class="section-content">{{ story_type.narrative_elements }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.emotional_arc %}
                                        <div class="section">
                                            <div class="section-title">Emotional Arc</div>
                                            <div class="section-content">{{ story_type.emotional_arc | arrow_format }}</div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.key_moment %}
                                        <div class="section">
                                            <div class="section-title">Key Moments</div>
                                            <div class="section-content">
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    {% for moment in story_type.key_moment %}
                                                    <li>{{ moment }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if story_type.common_elements %}
                                        <div class="section">
                                            <div class="section-title">Common Elements</div>
                                            <div class="section-content">{{ story_type.common_elements | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when story_type is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='story_type') }}" class="edit-button-external" title="Edit Story Type">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Story Type:</strong> {{ story_data.get('story_type_name') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Story Sub-Type with expandable details (separate from story type) -->
                                {% if story_data.get('subtype_name') %}
                                {% if subtype %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='subtype') }}" class="edit-button-external" title="Edit Story Sub-Type">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleSubtypeDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Story Sub-Type:</strong> {{ story_data.get('subtype_name') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="subtype-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="subtype-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ subtype.description }}</div>
                                        </div>

                                        {% if subtype.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ subtype.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when subtype object is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='subtype') }}" class="edit-button-external" title="Edit Story Sub-Type">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Story Sub-Type:</strong> {{ story_data.get('subtype_name') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                {% endif %}
                                {% if story_data.get('key_theme') %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='key_theme') }}" class="edit-button-external" title="Edit Key Theme">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Key Theme:</strong> {{ story_data.get('key_theme') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if story_data.get('core_arc') %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='core_arc') }}" class="edit-button-external" title="Edit Core Arc">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Core Arc:</strong> {{ story_data.get('core_arc') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Genre with expandable details -->
                                {% if story_data.get('genre_name') %}
                                {% if story and story.genre %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='genre') }}" class="edit-button-external" title="Edit Genre">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleGenreDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Genre:</strong> {{ story_data.get('genre_name') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="genre-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="genre-details-content">
                                        {% if story.genre.subgenres %}
                                        <div class="section">
                                            <div class="section-title">Sub-Genres</div>
                                            <div class="section-content">
                                                {% for subgenre in story.genre.subgenres %}
                                                    {{ subgenre.name }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when genre object is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='genre') }}" class="edit-button-external" title="Edit Genre">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Genre:</strong> {{ story_data.get('genre_name') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                
                                <!-- Sub-Genre with expandable details -->
                                {% if story_data.get('sub_genre_name') %}
                                {% if story and story.sub_genre %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='sub_genre') }}" class="edit-button-external" title="Edit Sub-Genre">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleSubGenreDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Sub-Genre:</strong> {{ story_data.get('sub_genre_name') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="subgenre-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="subgenre-details-content">
                                        {% if story.sub_genre.plot %}
                                        <div class="section">
                                            <div class="section-title">Plot Type</div>
                                            <div class="section-content">{{ story.sub_genre.plot }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if story.sub_genre.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ story.sub_genre.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if story.sub_genre.archetypes %}
                                        <div class="section">
                                            <div class="section-title">Typical Archetypes</div>
                                            <div class="section-content">{{ story.sub_genre.archetypes | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when sub-genre object is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='sub_genre') }}" class="edit-button-external" title="Edit Sub-Genre">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Sub-Genre:</strong> {{ story_data.get('sub_genre_name') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
          
                                <!-- Writing Style with expandable details -->
                                {% if story_data.get('writing_style_name') %}
                                {% if writing_style_obj %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='writing_style') }}" class="edit-button-external" title="Edit Writing Style">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleWritingStyleDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Writing Style:</strong> {{ story_data.get('writing_style_name') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="writingstyle-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="writingstyle-details-content">
                                        <div class="section">
                                            <div class="section-title">Description</div>
                                            <div class="section-content">{{ writing_style_obj.description }}</div>
                                        </div>
                                        
                                        {% if writing_style_obj.characteristics %}
                                        <div class="section">
                                            <div class="section-title">Characteristics</div>
                                            <div class="section-content">
                                                <ul style="margin: 0; padding-left: 20px;">
                                                    {% for characteristic in writing_style_obj.characteristics %}
                                                    <li>{{ characteristic }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if writing_style_obj.examples %}
                                        <div class="section">
                                            <div class="section-title">Examples</div>
                                            <div class="section-content">{{ writing_style_obj.examples | join(', ') }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when writing style object is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='writing_style') }}" class="edit-button-external" title="Edit Writing Style">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Writing Style:</strong> {{ story_data.get('writing_style_name') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}

                                <!-- Protagonist with expandable details -->

                                {% if story_data.get('protagonist_archetype') %}
                                {% if protagonist_archetype_obj %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='protagonist_archetype') }}" class="edit-button-external" title="Edit Protagonist">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleProtagonistDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Protagonist:</strong> {{ story_data.get('protagonist_archetype') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="protagonist-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                        <div class="expandable-panel-content" id="protagonist-details-content">
                                            <div class="section">
                                                <div class="section-title">Description</div>
                                                <div class="section-content">{{ protagonist_archetype_obj.description }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when protagonist archetype object is not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='protagonist_archetype') }}" class="edit-button-external" title="Edit Protagonist">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Protagonist:</strong> {{ story_data.get('protagonist_archetype') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                                
                                <!-- Live Secondary Characters selection (on secondary selection page) -->
                                {% if is_secondary_selection_page and story_data and story_data.get('protagonist_archetype') and not story_data.get('secondary_archetypes') %}
                                <div class="selection-wrapper">
                                    <span class="edit-button-invisible">üóëÔ∏è</span>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleLiveSecondaryDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Secondary Characters:</strong> <span id="live-secondary-list">none</span>
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="live-secondary-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                        <div class="expandable-panel-content" id="live-secondary-details-content">
                                            <div id="live-secondary-descriptions"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Secondary Characters with expandable details -->
                                {% if story_data.get('secondary_archetypes') %}
                                {% if secondary_archetype_objs %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='secondary_archetypes') }}" class="edit-button-external" title="Edit Secondary Characters">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleSecondaryDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Secondary Characters:</strong> {{ story_data.get('secondary_archetypes') | join(', ') }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="secondary-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                    <div class="expandable-panel-content" id="secondary-details-content">
                                        {% for archetype in secondary_archetype_objs %}
                                        <div class="section">
                                            <div class="section-title">{{ archetype.name }}</div>
                                            <div class="section-content">{{ archetype.description }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                </div>
                                {% else %}
                                <!-- Fallback for when secondary archetype objects are not available -->
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('navigate_to_step', step='secondary_archetypes') }}" class="edit-button-external" title="Edit Secondary Characters">üóëÔ∏è</a>
                                    <div class="selection-item">
                                        <div>
                                            <strong>Secondary Characters:</strong> {{ story_data.get('secondary_archetypes') | join(', ') }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}

                                
                                <!-- Selected Plot Line with expandable details -->
                                {% if story and story.selected_plot_line %}
                                <div class="selection-wrapper">
                                    <a href="{{ url_for('edit_plot_line') }}" class="edit-button-external" title="Change Plot Line">üóëÔ∏è</a>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="togglePlotLineDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Selected Plot Line:</strong> {{ story.selected_plot_line.name }}
                                            </div>
                                            <div class="panel-controls">
                                                <span class="expand-arrow" id="plotline-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                        <div class="expandable-panel-content" id="plotline-details-content">
                                            <div class="section">
                                                <div class="section-title">Plot Line</div>
                                                <div class="section-content">{{ story.selected_plot_line.plotline }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Generate Characters button - appears only when plot line is selected and no characters generated yet -->
                                {% if story and story.selected_plot_line and not story.expanded_plot_line %}
                                <div class="generate-characters-section" id="generate-characters-section">
                                    <button class="generate-button" id="generate-characters-button" onclick="handleGenerateCharacters(event)">
                                        üë• Generate characters
                                    </button>
                                </div>
                                {% endif %}
                                
                                <!-- Expanded Plot Line and Characters - appears when characters are generated -->
                                {% if story and story.expanded_plot_line %}
                                <div class="selection-wrapper">
                                    <span class="edit-button-invisible">‚úèÔ∏è</span>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleExpandedStoryDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Expanded Story:</strong> Plot & Characters Generated
                                            </div>
                                            <div class="panel-controls">
                                                <a href="{{ url_for('expanded_story') }}" class="edit-button" title="View Full Expanded Story">üëÅÔ∏è</a>
                                                <span class="expand-arrow" id="expanded-story-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                        <div class="expandable-panel-content" id="expanded-story-details-content">
                                            <div class="section">
                                                <div class="section-title">Characters ({{ story.characters|length }})</div>
                                                <div class="section-content">
                                                    {% for character in story.characters %}
                                                    <div class="character-summary">
                                                        <strong>{{ character.name }}</strong> - {{ character.archetype.value }}
                                                        <div class="character-roles-summary">
                                                            {{ character.functional_role.value }} | {{ character.emotional_function.value }}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="section">
                                                <div class="section-title">Expanded Plot</div>
                                                <div class="section-content">
                                                    <div class="expanded-plot-summary">
                                                        {{ story.expanded_plot_line[:200] }}{% if story.expanded_plot_line|length > 200 %}...{% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Generate Chapter Plan button - appears only when expanded story exists and no chapters generated yet -->
                                {% if story and story.expanded_plot_line and story.characters and not story.chapters %}
                                <div class="generate-chapters-section" id="generate-chapters-section">
                                    <button class="generate-button" id="generate-chapters-button" onclick="handleGenerateChapters(event)">
                                        üìö Generate chapter plan
                                    </button>
                                </div>
                                {% endif %}
                                
                                <!-- Chapter Plan - appears when chapters are generated -->
                                {% if story and story.chapters %}
                                <div class="selection-wrapper">
                                    <span class="edit-button-invisible">‚úèÔ∏è</span>
                                    <div class="expandable-panel">
                                        <div class="expandable-panel-header" onclick="toggleChapterPlanDetails()">
                                            <div class="expandable-panel-label">
                                                <strong>Chapter Plan:</strong> {{ story.chapters|length }} Chapters Generated
                                            </div>
                                            <div class="panel-controls">
                                                <a href="{{ url_for('chapter_plan') }}" class="edit-button" title="View Full Chapter Plan">üëÅÔ∏è</a>
                                                <span class="expand-arrow" id="chapter-plan-expand-arrow">‚ñ∂</span>
                                            </div>
                                        </div>
                                        <div class="expandable-panel-content" id="chapter-plan-details-content">
                                            <div class="section">
                                                <div class="section-title">Chapter Overview</div>
                                                <div class="section-content">
                                                    {% for chapter in story.get_chapters_ordered() %}
                                                    <div class="chapter-summary">
                                                        <strong>Chapter {{ chapter.chapter_number }}: {{ chapter.title }}</strong>
                                                        {% if chapter.narrative_function %}
                                                        <div class="chapter-function">{{ chapter.narrative_function.value }}</div>
                                                        {% endif %}
                                                        <div class="chapter-overview-text">{{ chapter.overview[:150] }}{% if chapter.overview|length > 150 %}...{% endif %}</div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Individual Chapter Generation - appears on chapter plan page -->
                                <!-- Debug: Chapter button conditions -->
                                <!-- DEBUG: is_chapter_plan_page={{ is_chapter_plan_page|default('UNDEFINED') }}, story={{ 'exists' if story else 'MISSING' }}, story.chapters={{ story.chapters|length if story and story.chapters else 'MISSING' }} -->
                                {% if is_chapter_plan_page and story and story.chapters %}
                                    <!-- DEBUG: Inside chapter generation logic -->
                                    {% set first_chapter_without_text = none %}
                                    {% for chapter in story.get_chapters_ordered() %}
                                        {% if not chapter.chapter_text and first_chapter_without_text is none %}
                                            {% set first_chapter_without_text = chapter %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- DEBUG: first_chapter_without_text={{ 'Chapter ' + first_chapter_without_text.chapter_number|string if first_chapter_without_text else 'NONE' }} -->
                                    {% for chapter in story.get_chapters_ordered() %}
                                        <!-- DEBUG: Chapter {{ chapter.chapter_number }}: has_text={{ 'YES' if chapter.chapter_text else 'NO' }}, is_first={{ 'YES' if (not chapter.chapter_text and first_chapter_without_text and chapter.chapter_number == first_chapter_without_text.chapter_number) else 'NO' }} -->
                                        {% if not chapter.chapter_text and first_chapter_without_text and chapter.chapter_number == first_chapter_without_text.chapter_number %}
                                        <!-- Generate Chapter button for the first chapter without text -->
                                        <!-- DEBUG: SHOWING GENERATE BUTTON for Chapter {{ chapter.chapter_number }} -->
                                        <div class="generate-chapter-section" id="generate-chapter-{{ chapter.chapter_number }}-section">
                                            <button class="generate-button compact" id="generate-chapter-{{ chapter.chapter_number }}-button" onclick="handleGenerateChapter(event, {{ chapter.chapter_number }})">
                                                üìù Generate chapter {{ chapter.chapter_number }}
                                            </button>
                                        </div>
                                        {% elif chapter.chapter_text %}
                                        <!-- Expandable Chapter panel for generated chapters -->
                                        <!-- DEBUG: SHOWING EXPANDABLE PANEL for Chapter {{ chapter.chapter_number }} -->
                                        <div class="selection-wrapper">
                                            <span class="edit-button-invisible">‚úèÔ∏è</span>
                                            <div class="expandable-panel">
                                                <div class="expandable-panel-header" onclick="toggleChapterDetails({{ chapter.chapter_number }})">
                                                    <div class="expandable-panel-label">
                                                        <strong>Chapter {{ chapter.chapter_number }}:</strong> {{ chapter.title }}
                                                    </div>
                                                    <div class="panel-controls">
                                                        <span class="expand-arrow" id="chapter-{{ chapter.chapter_number }}-expand-arrow">‚ñ∂</span>
                                                    </div>
                                                </div>
                                                <div class="expandable-panel-content" id="chapter-{{ chapter.chapter_number }}-details-content">
                                                    <div class="section">
                                                        <div class="section-title">Chapter Summary</div>
                                                        <div class="section-content">{{ chapter.summary or chapter.overview }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- DEBUG: Chapter generation logic NOT executed -->
                                    <!-- DEBUG: is_chapter_plan_page={{ is_chapter_plan_page|default('UNDEFINED') }}, story={{ 'exists' if story else 'MISSING' }}, story.chapters={{ story.chapters|length if story and story.chapters else 'MISSING/EMPTY' }} -->
                                {% endif %}
                                
                                <!-- Note and Generate plot lines button - appears only on secondary character selection page -->
                                {% if is_secondary_selection_page and story_data and story_data.get('protagonist_archetype') %}
                                <div class="secondary-notes-section" id="secondary-notes-section">
                                    <div class="archetype-selection-info">
                                        <p><strong>Note:</strong> Selection of secondary character archetypes is optional. You can select multiple archetypes or none at all. These will be some of supporting characters in your story. If you don't select any, they will be chosen for you.</p>
                                    </div>
                                </div>
                                <div class="generate-plotlines-section" id="generate-plotlines-section">
                                    <button class="generate-button" id="generate-plotlines-button" onclick="handleGeneratePlotLines(event)">
                                        üìã Generate plot lines
                                    </button>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="no-selections">
                                    No selections made yet. Start by choosing a story type.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endblock %}
            </div>
            
            <!-- Right panel for choices and navigation -->
            <div class="right-panel">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="flash-messages">
                            {% for category, message in messages %}
                                <div class="flash-message flash-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('load-file').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                // Submit the form to let the server handle the redirect properly
                document.getElementById('load-form').submit();
            }
        });
        
        function confirmNewStory() {
            if (confirm('Are you sure you want to start a new story? This will clear all your current selections.')) {
                window.location.href = '{{ url_for("new_story") }}';
            }
        }
        
        function toggleStoryTypeDetails() {
            const content = document.getElementById('story-type-details-content');
            const arrow = document.getElementById('story-type-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        // Prevent edit button clicks from triggering panel toggle
        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('.edit-button-external');
            editButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        });
        
        function toggleSubtypeDetails() {
            const content = document.getElementById('subtype-details-content');
            const arrow = document.getElementById('subtype-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleGenreDetails() {
            const content = document.getElementById('genre-details-content');
            const arrow = document.getElementById('genre-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleSubGenreDetails() {
            const content = document.getElementById('subgenre-details-content');
            const arrow = document.getElementById('subgenre-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleProtagonistDetails() {
            const content = document.getElementById('protagonist-details-content');
            const arrow = document.getElementById('protagonist-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleWritingStyleDetails() {
            const content = document.getElementById('writingstyle-details-content');
            const arrow = document.getElementById('writingstyle-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleSecondaryDetails() {
            const content = document.getElementById('secondary-details-content');
            const arrow = document.getElementById('secondary-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        

        function toggleLiveSecondaryDetails() {
            const content = document.getElementById('live-secondary-details-content');
            const arrow = document.getElementById('live-secondary-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function handleGeneratePlotLines(event) {
            // Always prevent default action since this is now a button
            event.preventDefault();
            
            // First, save secondary character selections if we're on the secondary archetype page
            const secondaryForm = document.getElementById('secondary-form');
            if (secondaryForm) {
                // Collect selected secondary archetypes
                const selectedArchetypes = [];
                const checkboxes = secondaryForm.querySelectorAll('input[name="secondary_archetypes"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedArchetypes.push(checkbox.value);
                });
                
                // Create FormData and submit to save secondary archetypes first
                const formData = new FormData();
                selectedArchetypes.forEach(archetype => {
                    formData.append('secondary_archetypes', archetype);
                });
                
                // Submit secondary archetype selection first
                fetch('/secondary-archetype-selection', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // After saving secondary archetypes, proceed with plot line generation
                        startPlotLineGeneration();
                    } else {
                        alert('Error saving secondary character selections');
                        return;
                    }
                })
                .catch(error => {
                    alert('Error saving secondary character selections: ' + error.message);
                    return;
                });
            } else {
                // If not on secondary archetype page, proceed directly with plot line generation
                startPlotLineGeneration();
            }
            
            return false;
        }
        
        function startPlotLineGeneration() {
            // Replace right panel content with intermediate page
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                // Store original content
                const originalContent = rightPanel.innerHTML;
                
                // Replace with generating plot lines page
                rightPanel.innerHTML = `
                <div class="generating-page">
                    <div class="page-header">
                        <h1>Generating Plot Lines</h1>
                        <p class="page-subtitle">Creating potential plot lines based on your story configuration...</p>
                    </div>
                    
                    <div class="generating-content">
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <h2>Generating potential plot lines</h2>
                            <p>This could take a few moments while we analyze your story configuration and create personalized plot options for you.</p>
                            
                            <div class="progress-steps">
                                <div class="step active">
                                    <span class="step-number">1</span>
                                    <span class="step-text">Analyzing your story selections</span>
                                </div>
                                <div class="step active">
                                    <span class="step-number">2</span>
                                    <span class="step-text">Generating plot variations</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span class="step-text">Preparing your options</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .generating-page {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 60vh;
                    text-align: center;
                    padding: 2rem;
                }

                .page-header h1 {
                    color: #4CAF50;
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }

                .page-subtitle {
                    color: #64B5F6;
                    font-size: 1.2rem;
                    margin-bottom: 3rem;
                }

                .generating-content {
                    max-width: 600px;
                    width: 100%;
                }

                .loading-indicator h2 {
                    color: #ffffff;
                    font-size: 1.8rem;
                    margin-bottom: 1rem;
                }

                .loading-indicator p {
                    color: #cccccc;
                    font-size: 1.1rem;
                    margin-bottom: 2rem;
                    line-height: 1.6;
                }

                .loading-spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid #333333;
                    border-top: 4px solid #4CAF50;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 2rem;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }

                .progress-steps {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    max-width: 500px;
                    margin: 0 auto;
                    padding: 0 1rem;
                }

                .step {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    flex: 1;
                    position: relative;
                    color: #666666;
                }

                .step.active {
                    color: #4CAF50;
                }

                .step-number {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background-color: #333333;
                    color: #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.1rem;
                }

                .step.active .step-number {
                    background-color: #4CAF50;
                    color: #ffffff;
                }

                .step-text {
                    font-size: 0.9rem;
                    text-align: center;
                    max-width: 120px;
                    line-height: 1.3;
                }

                .step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    top: 20px;
                    left: 60%;
                    right: -40%;
                    height: 2px;
                    background-color: #333333;
                    z-index: -1;
                }

                .step.active:not(:last-child)::after {
                    background-color: #4CAF50;
                }
                </style>
                `;
                
                // Animate the third step after a delay
                setTimeout(() => {
                    const steps = rightPanel.querySelectorAll('.step');
                    if (steps[2]) {
                        steps[2].classList.add('active');
                    }
                }, 2000);
            }
            
            // Hide the button and note from left panel (no loading message)
            const button = document.getElementById('generate-plotlines-button');
            const notesSection = document.getElementById('secondary-notes-section');
            const plotlinesSection = document.getElementById('generate-plotlines-section');
            
            if (button) button.style.display = 'none';
            if (notesSection) notesSection.style.display = 'none';
            if (plotlinesSection) plotlinesSection.style.display = 'none';
            
            
            // Make API call to generate plot lines
            fetch('/generate-plot-lines', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.plot_lines) {
                    // Store plot lines in sessionStorage for the completion page
                    sessionStorage.setItem('generated_plot_lines', JSON.stringify(data.plot_lines));
                    sessionStorage.setItem('plot_lines_generated', 'true');
                    
                    // Navigate to story completion page
                    window.location.href = '/complete-story-selection';
                } else {
                    // Show error and reload page to restore original state
                    alert('Error generating plot lines: ' + (data.error || 'Unknown error'));
                    window.location.reload();
                }
            })
            .catch(error => {
                // Show error and reload page to restore original state  
                alert('Network error: ' + error.message);
                window.location.reload();
            });
        }
        
        // Function to update live secondary characters display
        function updateLiveSecondaryCharacters() {
            const checkboxes = document.querySelectorAll('input[name="secondary_archetypes"]:checked');
            const liveList = document.getElementById('live-secondary-list');
            const liveDescriptions = document.getElementById('live-secondary-descriptions');
            
            if (!liveList || !liveDescriptions) return;
            
            if (checkboxes.length === 0) {
                liveList.textContent = 'none';
                liveDescriptions.innerHTML = '';
            } else {
                const selectedNames = [];
                const descriptions = [];
                
                checkboxes.forEach(checkbox => {
                    const archetypeCard = checkbox.closest('.archetype-card');
                    if (archetypeCard) {
                        const nameElement = archetypeCard.querySelector('.archetype-name');
                        const descElement = archetypeCard.querySelector('.archetype-description');
                        if (nameElement && descElement) {
                            selectedNames.push(nameElement.textContent.trim());
                            descriptions.push({
                                name: nameElement.textContent.trim(),
                                description: descElement.textContent.trim()
                            });
                        }
                    }
                });
                
                liveList.textContent = selectedNames.join(', ');
                
                // Build descriptions HTML
                let descriptionsHtml = '';
                descriptions.forEach(item => {
                    descriptionsHtml += `
                        <div class="section">
                            <div class="section-title">${item.name}</div>
                            <div class="section-content">${item.description}</div>
                        </div>
                    `;
                });
                liveDescriptions.innerHTML = descriptionsHtml;
            }
        }
        
        // Initialize live secondary characters monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Monitor secondary archetype checkboxes
            const checkboxes = document.querySelectorAll('input[name="secondary_archetypes"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateLiveSecondaryCharacters);
            });
            
            // Initial update
            updateLiveSecondaryCharacters();
        });
        
        // Toggle plot line details expansion
        function togglePlotLineDetails() {
            const content = document.getElementById('plotline-details-content');
            const arrow = document.getElementById('plotline-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function handleGenerateCharacters(event) {
            // Prevent default action since this is a button
            event.preventDefault();
            
            // Hide the generate characters button
            const generateCharactersButton = document.getElementById('generate-characters-button');
            const generateCharactersSection = document.getElementById('generate-characters-section');
            if (generateCharactersSection) {
                generateCharactersSection.style.display = 'none';
            }
            
            // Replace right panel content with generating characters page
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                // Store original content
                const originalContent = rightPanel.innerHTML;
                
                // Replace with generating characters page
                rightPanel.innerHTML = `
                <div class="generating-page">
                    <div class="page-header">
                        <h1>Generating Characters</h1>
                        <p class="page-subtitle">Creating detailed characters and expanding your plot line...</p>
                    </div>
                    
                    <div class="generating-content">
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <h2>Developing your characters</h2>
                            <p>This could take a few moments while we create detailed character profiles and expand your plot line to incorporate them.</p>
                            
                            <div class="progress-steps">
                                <div class="step active">
                                    <span class="step-number">1</span>
                                    <span class="step-text">Analyzing plot line and story</span>
                                </div>
                                <div class="step active">
                                    <span class="step-number">2</span>
                                    <span class="step-text">Creating character profiles</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span class="step-text">Expanding plot line</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .generating-page {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 60vh;
                    text-align: center;
                    padding: 2rem;
                }

                .page-header h1 {
                    color: #4CAF50;
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }

                .page-subtitle {
                    color: #64B5F6;
                    font-size: 1.2rem;
                    margin-bottom: 3rem;
                }

                .generating-content {
                    max-width: 600px;
                    width: 100%;
                }

                .loading-indicator h2 {
                    color: #ffffff;
                    font-size: 1.8rem;
                    margin-bottom: 1rem;
                }

                .loading-indicator p {
                    color: #cccccc;
                    font-size: 1.1rem;
                    margin-bottom: 2rem;
                    line-height: 1.6;
                }

                .loading-spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid #333333;
                    border-top: 4px solid #4CAF50;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 2rem;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }

                .progress-steps {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    max-width: 500px;
                    margin: 0 auto;
                    padding: 0 1rem;
                }

                .step {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    flex: 1;
                    position: relative;
                    color: #666666;
                }

                .step.active {
                    color: #4CAF50;
                }

                .step-number {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background-color: #333333;
                    color: #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.1rem;
                }

                .step.active .step-number {
                    background-color: #4CAF50;
                    color: #ffffff;
                }

                .step-text {
                    font-size: 0.9rem;
                    text-align: center;
                    max-width: 120px;
                    line-height: 1.3;
                }

                .step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    top: 20px;
                    left: 60%;
                    right: -40%;
                    height: 2px;
                    background-color: #333333;
                    z-index: -1;
                }

                .step.active:not(:last-child)::after {
                    background-color: #4CAF50;
                }
                </style>
                `;
                
                // Make API call to generate characters
                fetch('/generate-characters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store the expanded plot line and characters data
                        sessionStorage.setItem('characters_generated', 'true');
                        sessionStorage.setItem('expanded_plot_line', data.expanded_plot_line || '');
                        sessionStorage.setItem('generated_characters', JSON.stringify(data.characters || []));
                        
                        // Redirect to the expanded story page
                        window.location.href = '/expanded-story';
                    } else {
                        // Restore original content and show error
                        rightPanel.innerHTML = originalContent;
                        
                        // Restore the generate characters button
                        if (generateCharactersSection) {
                            generateCharactersSection.style.display = 'block';
                        }
                        
                        alert('Error generating characters: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    // Restore original content and show error
                    rightPanel.innerHTML = originalContent;
                    
                    // Restore the generate characters button
                    if (generateCharactersSection) {
                        generateCharactersSection.style.display = 'block';
                    }
                    
                    alert('Error generating characters: ' + error.message);
                });
            }
            
            return false;
        }
        
        function handleGenerateChapters(event) {
            // Prevent default action since this is a button
            event.preventDefault();
            
            // Hide the generate chapters button
            const generateChaptersButton = document.getElementById('generate-chapters-button');
            const generateChaptersSection = document.getElementById('generate-chapters-section');
            if (generateChaptersSection) {
                generateChaptersSection.style.display = 'none';
            }
            
            // Replace right panel content with generating chapters page
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                // Store original content
                const originalContent = rightPanel.innerHTML;
                
                // Replace with generating chapters page
                rightPanel.innerHTML = `
                <div class="generating-page">
                    <div class="page-header">
                        <h1>Generating Chapter Plan</h1>
                        <p class="page-subtitle">Creating detailed chapter outline with narrative structure...</p>
                    </div>
                    
                    <div class="generating-content">
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <h2>Planning your chapters</h2>
                            <p>This could take a few moments while we create a detailed chapter-by-chapter outline with character impacts and narrative structure.</p>
                            
                            <div class="progress-steps">
                                <div class="step active">
                                    <span class="step-number">1</span>
                                    <span class="step-text">Analyzing story structure</span>
                                </div>
                                <div class="step active">
                                    <span class="step-number">2</span>
                                    <span class="step-text">Creating chapter outline</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span class="step-text">Adding narrative functions</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .generating-page {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 60vh;
                    text-align: center;
                    padding: 2rem;
                }

                .page-header h1 {
                    color: #4CAF50;
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }

                .page-subtitle {
                    color: #64B5F6;
                    font-size: 1.2rem;
                    margin-bottom: 3rem;
                }

                .generating-content {
                    max-width: 600px;
                    width: 100%;
                }

                .loading-indicator h2 {
                    color: #ffffff;
                    font-size: 1.8rem;
                    margin-bottom: 1rem;
                }

                .loading-indicator p {
                    color: #cccccc;
                    font-size: 1.1rem;
                    margin-bottom: 2rem;
                    line-height: 1.6;
                }

                .loading-spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid #333333;
                    border-top: 4px solid #4CAF50;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 2rem;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }

                .progress-steps {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    max-width: 500px;
                    margin: 0 auto;
                    padding: 0 1rem;
                }

                .step {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    flex: 1;
                    position: relative;
                    color: #666666;
                }

                .step.active {
                    color: #4CAF50;
                }

                .step-number {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background-color: #333333;
                    color: #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.1rem;
                }

                .step.active .step-number {
                    background-color: #4CAF50;
                    color: #ffffff;
                }

                .step-text {
                    font-size: 0.9rem;
                    text-align: center;
                    max-width: 120px;
                    line-height: 1.3;
                }

                .step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    top: 20px;
                    left: 60%;
                    right: -40%;
                    height: 2px;
                    background-color: #333333;
                    z-index: -1;
                }

                .step.active:not(:last-child)::after {
                    background-color: #4CAF50;
                }
                </style>
                `;
                
                // Make API call to generate chapters
                fetch('/generate-chapters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Navigate to chapter plan page to show the chapters
                        window.location.href = '/chapter-plan';
                    } else {
                        // Restore original content and show error
                        rightPanel.innerHTML = originalContent;
                        
                        // Restore the generate chapters button
                        if (generateChaptersSection) {
                            generateChaptersSection.style.display = 'block';
                        }
                        
                        // Check if it's a character validation error
                        if (data.error === 'character_validation') {
                            // Show character validation error
                            const errorMessage = `The chapter plan references characters that don't exist in your story: ${data.missing_characters.join(', ')}. Please regenerate characters or contact support.`;
                            
                            // Create error bubble
                            const errorBubble = document.createElement('div');
                            errorBubble.className = 'error-bubble';
                            errorBubble.innerHTML = `
                                <div class="error-content">
                                    <span class="error-icon">‚ö†Ô∏è</span>
                                    <span class="error-text">${errorMessage}</span>
                                    <button class="error-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                                </div>
                            `;
                            
                            // Insert at top of right panel
                            rightPanel.insertBefore(errorBubble, rightPanel.firstChild);
                        } else {
                            alert('Error generating chapter plan: ' + (data.error || 'Unknown error'));
                        }
                    }
                })
                .catch(error => {
                    // Restore original content and show error
                    rightPanel.innerHTML = originalContent;
                    
                    // Restore the generate chapters button
                    if (generateChaptersSection) {
                        generateChaptersSection.style.display = 'block';
                    }
                    
                    alert('Error generating chapter plan: ' + error.message);
                });
            }
            
            return false;
        }
        
        function handleGenerateChapter(event, chapterNumber) {
            event.preventDefault();
            
            // Hide the generate chapter button for this chapter
            const generateChapterSection = document.getElementById(`generate-chapter-${chapterNumber}-section`);
            if (generateChapterSection) {
                generateChapterSection.style.display = 'none';
            }
            
            // Replace right panel content with generating chapter page
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                // Store original content
                const originalContent = rightPanel.innerHTML;
                
                // Replace with generating chapter page
                rightPanel.innerHTML = `
                <div class="generating-page">
                    <div class="page-header">
                        <h1>Generating Chapter ${chapterNumber}</h1>
                        <p class="page-subtitle">Creating full chapter text with narrative prose...</p>
                    </div>
                    
                    <div class="generating-content">
                        <div class="loading-indicator">
                            <div class="loading-spinner"></div>
                            <h2>Writing Chapter ${chapterNumber}</h2>
                            <p>This could take a few moments while we generate approximately 1000 words of prose along with continuity tracking.</p>
                            
                            <div class="progress-steps">
                                <div class="step active">
                                    <span class="step-number">1</span>
                                    <span class="step-text">Analyzing story context</span>
                                </div>
                                <div class="step active">
                                    <span class="step-number">2</span>
                                    <span class="step-text">Writing chapter prose</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span class="step-text">Tracking continuity</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .generating-page {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 60vh;
                    text-align: center;
                    padding: 2rem;
                }

                .page-header h1 {
                    color: #4CAF50;
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }

                .page-subtitle {
                    color: #64B5F6;
                    font-size: 1.2rem;
                    margin-bottom: 3rem;
                }

                .generating-content {
                    max-width: 600px;
                    width: 100%;
                }

                .loading-indicator h2 {
                    color: #ffffff;
                    font-size: 1.8rem;
                    margin-bottom: 1rem;
                }

                .loading-indicator p {
                    color: #cccccc;
                    font-size: 1.1rem;
                    margin-bottom: 2rem;
                    line-height: 1.6;
                }

                .loading-spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid #333333;
                    border-top: 4px solid #4CAF50;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 2rem;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }

                .progress-steps {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    max-width: 500px;
                    margin: 0 auto;
                    padding: 0 1rem;
                }

                .step {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    flex: 1;
                    position: relative;
                    color: #666666;
                }

                .step.active {
                    color: #4CAF50;
                }

                .step-number {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background-color: #333333;
                    color: #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    margin-bottom: 0.5rem;
                    font-size: 1.1rem;
                }

                .step.active .step-number {
                    background-color: #4CAF50;
                    color: #ffffff;
                }

                .step-text {
                    font-size: 0.9rem;
                    text-align: center;
                    max-width: 120px;
                    line-height: 1.3;
                }

                .step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    top: 20px;
                    left: 60%;
                    right: -40%;
                    height: 2px;
                    background-color: #333333;
                    z-index: -1;
                }

                .step.active:not(:last-child)::after {
                    background-color: #4CAF50;
                }
                </style>
                `;
                
                // Animate the third step after a delay
                setTimeout(() => {
                    const steps = rightPanel.querySelectorAll('.step');
                    if (steps[2]) {
                        steps[2].classList.add('active');
                    }
                }, 2000);
                
                // Make API call to generate the chapter
                fetch(`/generate-chapter/${chapterNumber}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show the generated chapter
                        window.location.reload();
                    } else {
                        // Restore original content and show error
                        rightPanel.innerHTML = originalContent;
                        
                        // Restore the generate chapter button
                        if (generateChapterSection) {
                            generateChapterSection.style.display = 'block';
                        }
                        
                        // Check if it's a character validation error
                        if (data.error === 'character_validation') {
                            showCharacterValidationError(data.missing_characters, data.message);
                        } else {
                            alert('Error generating chapter: ' + (data.error || 'Unknown error'));
                        }
                    }
                })
                .catch(error => {
                    // Restore original content and show error
                    rightPanel.innerHTML = originalContent;
                    
                    // Restore the generate chapter button
                    if (generateChapterSection) {
                        generateChapterSection.style.display = 'block';
                    }
                    
                    alert('Error generating chapter: ' + error.message);
                });
            }
            
            return false;
        }
        
        function showCharacterValidationError(missingCharacters, message) {
            // Create or update error bubble at top of page
            let errorBubble = document.getElementById('character-validation-error');
            if (!errorBubble) {
                errorBubble = document.createElement('div');
                errorBubble.id = 'character-validation-error';
                errorBubble.className = 'error-bubble';
                
                // Insert at the top of the right panel
                const rightPanel = document.querySelector('.right-panel');
                if (rightPanel && rightPanel.firstChild) {
                    rightPanel.insertBefore(errorBubble, rightPanel.firstChild);
                }
            }
            
            errorBubble.innerHTML = `
                <div class="error-content">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span class="error-text">${message}</span>
                    <button class="error-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            errorBubble.style.display = 'block';
        }
        
        function toggleChapterDetails(chapterNumber) {
            const content = document.getElementById(`chapter-${chapterNumber}-details-content`);
            const arrow = document.getElementById(`chapter-${chapterNumber}-expand-arrow`);
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleChapterPlanDetails() {
            const content = document.getElementById('chapter-plan-details-content');
            const arrow = document.getElementById('chapter-plan-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
        
        function toggleExpandedStoryDetails() {
            const content = document.getElementById('expanded-story-details-content');
            const arrow = document.getElementById('expanded-story-expand-arrow');
            
            if (content && arrow) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }
    </script>
</body>
</html>