{% extends "base.html" %}

{% block title %}Create New Story - Kraitif{% endblock %}

{% block content %}
<div class="header-section">
    <h1>Create New Story</h1>
    <p class="subtitle">Build your story by selecting genre, story type, and archetypes</p>
</div>

<div class="back-nav">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Home</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form method="POST" class="story-form">
    <div class="form-section">
        <h2>Basic Information</h2>
        
        <div class="form-group">
            <label for="title">Story Title *</label>
            <input type="text" id="title" name="title" required placeholder="Enter your story title">
        </div>
        
        <div class="form-group">
            <label for="description">Story Description</label>
            <textarea id="description" name="description" rows="4" placeholder="Describe your story..."></textarea>
        </div>
    </div>

    <div class="form-section">
        <h2>Genre Selection</h2>
        
        <div class="form-group">
            <label for="genre">Genre</label>
            <select id="genre" name="genre" onchange="updateSubGenres()">
                <option value="">Select a genre...</option>
                {% for genre in genres %}
                <option value="{{ genre.name }}">{{ genre.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="sub_genre">Sub-genre</label>
            <select id="sub_genre" name="sub_genre" onchange="updateSuggestedArchetypes()">
                <option value="">Select a sub-genre...</option>
            </select>
        </div>
    </div>

    <div class="form-section">
        <h2>Story Type Selection</h2>
        
        <div class="form-group">
            <label for="story_type">Story Type</label>
            <select id="story_type" name="story_type" onchange="updateStorySubtypes()">
                <option value="">Select a story type...</option>
                {% for story_type in story_types %}
                <option value="{{ story_type.name }}">{{ story_type.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="story_subtype">Story Subtype</label>
            <select id="story_subtype" name="story_subtype">
                <option value="">Select a story subtype...</option>
            </select>
        </div>
    </div>

    <div class="form-section">
        <h2>Character Archetypes</h2>
        
        <div class="form-group">
            <label>Select Archetypes</label>
            <div class="archetype-selection">
                <div class="archetype-search">
                    <input type="text" id="archetype-search" placeholder="Search archetypes..." onkeyup="filterArchetypes()">
                </div>
                
                <div class="suggested-archetypes" id="suggested-archetypes" style="display: none;">
                    <h4>Suggested for this sub-genre:</h4>
                    <div id="suggested-list"></div>
                </div>
                
                <div class="archetype-grid">
                    {% for archetype in archetypes %}
                    <div class="archetype-item" data-name="{{ archetype.name|lower }}">
                        <label>
                            <input type="checkbox" name="archetypes" value="{{ archetype.name }}">
                            <span class="archetype-name">{{ archetype.name }}</span>
                            <span class="archetype-description">{{ archetype.description[:80] }}{% if archetype.description|length > 80 %}...{% endif %}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>Additional Notes</h2>
        
        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Any additional notes about your story..."></textarea>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Story</button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
function updateSubGenres() {
    const genreSelect = document.getElementById('genre');
    const subGenreSelect = document.getElementById('sub_genre');
    
    // Clear existing options
    subGenreSelect.innerHTML = '<option value="">Select a sub-genre...</option>';
    
    if (genreSelect.value) {
        fetch(`/api/sub_genres/${genreSelect.value}`)
            .then(response => response.json())
            .then(data => {
                data.sub_genres.forEach(subGenre => {
                    const option = document.createElement('option');
                    option.value = subGenre.name;
                    option.textContent = subGenre.name;
                    subGenreSelect.appendChild(option);
                });
            });
    }
    
    // Clear suggested archetypes
    document.getElementById('suggested-archetypes').style.display = 'none';
}

function updateStorySubtypes() {
    const storyTypeSelect = document.getElementById('story_type');
    const storySubtypeSelect = document.getElementById('story_subtype');
    
    // Clear existing options
    storySubtypeSelect.innerHTML = '<option value="">Select a story subtype...</option>';
    
    if (storyTypeSelect.value) {
        fetch(`/api/story_subtypes/${storyTypeSelect.value}`)
            .then(response => response.json())
            .then(data => {
                data.subtypes.forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype.name;
                    option.textContent = subtype.name;
                    storySubtypeSelect.appendChild(option);
                });
            });
    }
}

function updateSuggestedArchetypes() {
    const genreSelect = document.getElementById('genre');
    const subGenreSelect = document.getElementById('sub_genre');
    const suggestedDiv = document.getElementById('suggested-archetypes');
    const suggestedList = document.getElementById('suggested-list');
    
    if (genreSelect.value && subGenreSelect.value) {
        fetch(`/api/suggested_archetypes/${genreSelect.value}/${subGenreSelect.value}`)
            .then(response => response.json())
            .then(data => {
                if (data.archetypes.length > 0) {
                    suggestedList.innerHTML = '';
                    data.archetypes.forEach(archetype => {
                        const label = document.createElement('label');
                        label.className = 'suggested-archetype';
                        label.innerHTML = `
                            <input type="checkbox" name="archetypes" value="${archetype.name}">
                            <span class="archetype-name">${archetype.name}</span>
                            <span class="archetype-description">${archetype.description.substring(0, 60)}...</span>
                        `;
                        suggestedList.appendChild(label);
                    });
                    suggestedDiv.style.display = 'block';
                } else {
                    suggestedDiv.style.display = 'none';
                }
            });
    } else {
        suggestedDiv.style.display = 'none';
    }
}

function filterArchetypes() {
    const searchTerm = document.getElementById('archetype-search').value.toLowerCase();
    const archetypeItems = document.querySelectorAll('.archetype-item');
    
    archetypeItems.forEach(item => {
        const name = item.dataset.name;
        if (name.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}
</script>
{% endblock %}